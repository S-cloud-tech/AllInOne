{% extends "base.html" %}
{% load static %}

{% block content %}

    <main class="container mx-auto px-4 py-8">
        <div class="flex gap-8">
            <!-- Sidebar Filters -->
            <aside class="w-64 flex-shrink-0">
                <div class="bg-white rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-3">All Categories</h3>
                    <ul class="space-y-2 text-sm">
                        {% for cat in categories %}
                            <li>
                                <a href="?category={{ cat.slug }}" class="hover:text-green-600 {% if request.GET.category == cat.slug %}text-green-600 font-bold{% endif %}">
                                    {{ cat.name }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                {% comment %} <!-- Selected Filters -->
                <div class="bg-white rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-3 flex justify-between items-center">
                        SELECTED FILTERS
                        <button id="clearAll" class="text-green-600 text-xs">CLEAR ALL</button>
                    </h3>

                    <div id="selected-filters" class="mb-4 text-sm text-gray-700">
                        <!-- Dynamically filled by JS -->
                        <p class="text-xs text-gray-400">No filters applied</p>
                    </div>
                </div> {% endcomment %}


                {% comment %} <div class="bg-white rounded-lg p-4 mb-4">
                    <h3 class="font-semibold mb-3">PRICE RANGE</h3>
                    <input id="priceRange" type="range" class="w-full mb-2" min="0" max="2000" step="50" value="1000">
                    <div class="flex justify-between text-sm mb-2">
                        <span id="priceValue" class="text-gray-700">Price: 0 — 1,500</span>
                    </div>

                    <h3 class="font-semibold mb-3">RATING</h3>
                    <div id="ratingFilter" class="space-y-2">
                        {% for i in "54321" %}
                        <label class="flex items-center gap-2 cursor-pointer text-sm">
                            <input type="checkbox" name="rating" value="{{ i }}" class="rounded text-green-600 focus:ring-green-600">
                            <span class="text-yellow-400">
                            {% for s in "12345" %}
                                {% if forloop.counter <= i|add:"0"|int %}★{% else %}☆{% endif %}
                            {% endfor %}
                            </span>
                        </label>
                        {% endfor %}
                    </div>
                    <h3 class="font-semibold mb-3 mt-4">BRAND</h3>
                    {% for b in brands %}
                    <label class="flex items-center gap-2 mb-2 cursor-pointer">
                        <input type="checkbox" class="rounded">
                        <span class="text-sm">{{ b.name }}</span>
                    </label>
                    {% endfor %}

                    <button id="applyFilter" class="w-full bg-white border border-gray-300 rounded py-2 text-sm hover:border-green-600">
                        Apply FILTER
                    </button>
                </div> {% endcomment %}
            </aside>

            <!-- Products Grid -->
            <div class="flex-1">
                <div class="flex justify-between items-center mb-6">
                    {% comment %} <div class="flex gap-4 border-b">
                        <button class="px-4 py-2 font-semibold border-b-2 border-green-600 text-green-600">Coffee</button>
                        <button class="px-4 py-2 hover:text-green-600">Related coffee</button>
                        <button class="px-4 py-2 hover:text-green-600">Coffee capsules</button>
                        <button class="px-4 py-2 hover:text-green-600">Dry coffee</button>
                    </div> {% endcomment %}
                    <div class="flex gap-4 border-b"></div>
                    <div class="flex items-center gap-4">
                        <span class="text-sm text-gray-600">Sort by:</span>
                        <select name="sort" onchange="location = '?sort=' + this.value;" class="border rounded px-3 py-1 text-sm">
                            <option value="latest">Latest</option>
                            <option value="price_low">Price: Low to High</option>
                            <option value="price_high">Price: High to Low</option>
                        </select>
                        <div class="flex gap-2">
                            <button class="p-2 border rounded"><i class="fas fa-th"></i></button>
                            <button class="p-2 border rounded"><i class="fas fa-list"></i></button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-4 mb-8">
                    {% for product in products %}
                        <div class="bg-white rounded-lg p-4 hover:shadow-lg transition group relative">
                            {% if product.is_on_sale %}
                                <span class="absolute top-4 left-4 bg-blue-600 text-white text-xs px-2 py-1 rounded">Sale</span>
                            {% elif product.is_hot %}
                                <span class="absolute top-4 left-4 bg-red-500 text-white text-xs px-2 py-1 rounded">Hot</span>
                            {% elif product.is_new %}
                                <span class="absolute top-4 left-4 bg-green-500 text-white text-xs px-2 py-1 rounded">New</span>
                            {% endif %}
                            
                            <img src="{% if product.image %}{{ product.image.url }}{% else %}https://placehold.co/50x50{% endif %}" alt="{{ product.name }}" class="w-full h-48 object-cover mb-3 rounded">
                            
                            <p class="text-xs text-gray-500 mb-1">{{ product.brand.name }}</p>
                            <h3 class="text-sm font-medium mb-2">{{ product.name }}</h3>
                            
                            <div class="flex items-center gap-2 mb-2">
                                <span class="font-bold">{{ product.price }} ₼</span>
                                {% if product.old_price %}
                                    <span class="text-gray-400 line-through text-sm">{{ product.old_price }} ₼</span>
                                {% endif %}
                            </div>
                            
                            <div class="flex items-center gap-1 text-yellow-400 text-xs mb-2">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= product.rating|floatformat:0 %}
                                        ★
                                    {% else %}
                                        ☆
                                    {% endif %}
                                {% endfor %}
                            </div>
                            
                            <a href="{% url "orders:cart_add" product.id %}">
                                <button class="w-full bg-white border border-gray-300 rounded py-2 text-sm hover:bg-green-600 hover:text-white transition">
                                    <i class="fas fa-shopping-bag mr-2"></i>Add to Cart
                                </button>
                            </a>
                        </div>
                    {% empty %}
                        <p>No products found.</p>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                <div class="mt-8 flex justify-center">
                    {% if products.has_previous %}
                        <a href="?page={{ products.previous_page_number }}" class="px-3 py-1 border rounded">Prev</a>
                    {% endif %}
                    <span class="px-4 py-1">{{ products.number }} / {{ products.paginator.num_pages }}</span>
                    {% if products.has_next %}
                        <a href="?page={{ products.next_page_number }}" class="px-3 py-1 border rounded">Next</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>
    <script>
        const categoryEl = document.getElementById('category');
        const brandEl = document.getElementById('brand');
        const searchEl = document.getElementById('search');
        const minEl = document.getElementById('min_price');
        const maxEl = document.getElementById('max_price');
        const selectedFilters = document.getElementById('selected-filters');
        const clearAll = document.getElementById('clearAll');
        const priceRange = document.getElementById('priceRange');
        const priceValue = document.getElementById('priceValue');
        const ratingFilter = document.getElementById('ratingFilter');

        // Fetch and render products
        function applyFilters() {
            const category = categoryEl.value;
            const brand = brandEl.value;
            const search = searchEl.value;
            const min_price = minEl.value;
            const max_price = maxEl.value;

            const selectedRatings = Array.from(ratingFilter.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .join(',');

            fetch(`/catalog/?category=${category}&brand=${brand}&search=${search}&min_price=${min_price}&max_price=${max_price}`, {
                headers: { 'x-requested-with': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '';
                if (data.products.length === 0) {
                    grid.innerHTML = '<p>No products found.</p>';
                } else {
                    data.products.forEach(p => {
                        grid.innerHTML += `
                            <div class="bg-white rounded-lg shadow p-3 hover:shadow-lg transition">
                                <img src="${p.image_url}" alt="${p.name}" class="w-full h-48 object-cover rounded">
                                <h3 class="mt-2 font-semibold">${p.name}</h3>
                                <p class="text-gray-600 text-sm">${p.brand}</p>
                                <p class="text-blue-600 font-bold">$${p.price}</p>
                            </div>
                        `;
                    });
                }

                updateSelectedFilters();
            });
        }

        // Build Selected Filters Display
        function updateSelectedFilters() {
            selectedFilters.innerHTML = ''; // clear existing
            const filters = [];

            if (categoryEl.value) filters.push({ type: 'Category', value: categoryEl.options[categoryEl.selectedIndex].text });
            if (brandEl.value) filters.push({ type: 'Brand', value: brandEl.value });
            if (searchEl.value) filters.push({ type: 'Search', value: searchEl.value });
            if (minEl.value) filters.push({ type: 'Min Price', value: minEl.value });
            if (maxEl.value) filters.push({ type: 'Max Price', value: maxEl.value });

            if (filters.length === 0) {
                selectedFilters.innerHTML = '<p class="text-xs text-gray-400">No filters applied</p>';
                return;
            }

            filters.forEach(f => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1 border rounded text-xs hover:border-green-600 flex items-center gap-2';
                btn.innerHTML = `${f.type}: <span class="font-medium">${f.value}</span> <span class="text-red-500 font-bold">×</span>`;
                btn.addEventListener('click', () => {
                    removeFilter(f.type);
                });
                selectedFilters.appendChild(btn);
            });
        }

        // Remove an individual filter
        function removeFilter(type) {
            if (type === 'Category') categoryEl.value = '';
            if (type === 'Brand') brandEl.value = '';
            if (type === 'Search') searchEl.value = '';
            if (type === 'Min Price') minEl.value = '';
            if (type === 'Max Price') maxEl.value = '';
            applyFilters();
        }

        // Clear all filters
        clearAll.addEventListener('click', () => {
            categoryEl.value = '';
            brandEl.value = '';
            searchEl.value = '';
            minEl.value = '';
            maxEl.value = '';
            applyFilters();
        });

        // Attach to Apply button
        document.getElementById('applyFilter').addEventListener('click', applyFilters);

        // Live search
        searchEl.addEventListener('input', () => {
            applyFilters();
        });
    </script>
{% endblock content %}
